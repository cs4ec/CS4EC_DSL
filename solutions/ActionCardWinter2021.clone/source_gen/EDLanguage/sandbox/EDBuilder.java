package EDLanguage.sandbox;

/*Generated by MPS */

import repast.simphony.dataLoader.ContextBuilder;
import repast.simphony.context.Context;
import repast.simphony.parameter.Parameters;
import repast.simphony.engine.environment.RunEnvironment;
import simcore.utilities.ModelParameterStore;
import repast.simphony.context.space.continuous.ContinuousSpaceFactory;
import repast.simphony.context.space.continuous.ContinuousSpaceFactoryFinder;
import repast.simphony.space.continuous.ContinuousSpace;
import simcore.utilities.StaffAdder;
import repast.simphony.space.continuous.StrictBorders;
import repast.simphony.context.space.grid.GridFactory;
import repast.simphony.context.space.grid.GridFactoryFinder;
import repast.simphony.space.grid.Grid;
import repast.simphony.space.grid.GridBuilderParameters;
import repast.simphony.space.grid.SimpleGridAdder;
import simcore.basicStructures.Board;
import repast.simphony.valueLayer.GridValueLayer;
import simcore.basicStructures.Room;
import java.awt.Color;
import repast.simphony.space.continuous.NdPoint;
import repast.simphony.context.space.graph.NetworkBuilder;
import java.util.HashMap;
import simcore.utilities.PatientArrivalStore;
import java.util.Map;
import simcore.basicStructures.Wall;

public class EDBuilder implements ContextBuilder<Object> {

  public Context build(Context<Object> context) {

    context.setId("EDProject");
    int mapWidth = 548;
    int mapHeight = 308;

    Parameters params = RunEnvironment.getInstance().getParameters();

    Double pPrev = params.getDouble("Prevalence");
    Double pProportionSymptomatic = params.getDouble("PercentagePrevSymptomatic");

    Boolean pBool = params.getBoolean("UsePathFinding");
    ModelParameterStore.UsePathFinding = false;

    RunEnvironment.getInstance().endAt(86400);

    CreatePatientArrivalMap();

    ContinuousSpaceFactory spaceFactory = ContinuousSpaceFactoryFinder.createContinuousSpaceFactory(null);
    ContinuousSpace<Object> space = spaceFactory.createContinuousSpace("space", context, new StaffAdder<Object>(), new StrictBorders(), mapWidth, mapHeight);

    GridFactory gridFactory = GridFactoryFinder.createGridFactory(null);
    Grid<Object> grid = gridFactory.createGrid("grid", context, new GridBuilderParameters<Object>(new repast.simphony.space.grid.StrictBorders(), new SimpleGridAdder<Object>(), true, mapWidth, mapHeight));

    context.add(new patientGenerator(space, grid, context));
    context.add(new Board());

    // add Agents 
    for (int i = 0; i < 2; i++) {
      context.add(new Doctor(space, grid, context));
    }
    for (int i = 0; i < 3; i++) {
      context.add(new CubicleNurse(space, grid, context));
    }
    for (int i = 0; i < 5; i++) {
      context.add(new TriageNurse(space, grid, context));
    }


    GridValueLayer vl = new GridValueLayer("cellbox", true, new repast.simphony.space.grid.StrictBorders(), mapWidth, mapHeight);
    context.addValueLayer(vl);

    // add Locations here 
    Room AmberBay_a = new Room("AmberBay", context, space, grid, 424, 112, 74, 51, 1, 0, AmberBay.getInstance(), Color.ORANGE);
    Room Lab_b = new Room("Lab", context, space, grid, 50, 65, 89, 39, 1, 0, Lab.getInstance(), Color.GRAY);
    Room NonRespiratoryArea_c = new Room("NonRespiratoryArea", context, space, grid, 82, 114, 56, 43, 1, 0, NonRespiratoryArea.getInstance(), Color.BLUE);
    Room RespiratoryArea_d = new Room("RespiratoryArea", context, space, grid, 263, 216, 49, 40, 1, 0, RespiratoryArea.getInstance(), Color.RED);
    Room WaitingRoom_e = new Room("WaitingRoom", context, space, grid, 220, 115, 36, 52, 1, 0, WaitingRoom.getInstance(), Color.GRAY);
    Room WaitingRoom_f = new Room("WaitingRoom", context, space, grid, 145, 214, 64, 19, 1, 0, WaitingRoom.getInstance(), Color.GRAY);
    Room MajorsCBay_g = new Room("MajorsCBay", context, space, grid, 214, 16, 37, 16, 1, 0, MajorsCBay.getInstance(), Color.GREEN);
    Room MajorsABBay_h = new Room("MajorsABBay", context, space, grid, 322, 126, 26, 19, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    Room MajorsABBay_i = new Room("MajorsABBay", context, space, grid, 321, 142, 28, 15, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    Room MainEntrance_j = new Room("MainEntrance", context, space, grid, 86, 246, 33, 12, 1, 0, MainEntrance.getInstance(), Color.GRAY);
    Room MajorsCBay_k = new Room("MajorsCBay", context, space, grid, 216, 61, 24, 16, 1, 0, MajorsCBay.getInstance(), Color.GREEN);
    Room MajorsCBay_l = new Room("MajorsCBay", context, space, grid, 242, 62, 24, 16, 1, 0, MajorsCBay.getInstance(), Color.GREEN);
    Room MajorsCBay_m = new Room("MajorsCBay", context, space, grid, 215, 43, 26, 13, 1, 0, MajorsCBay.getInstance(), Color.GREEN);
    Room Triage_n = new Room("Triage", context, space, grid, 167, 189, 24, 14, 1, 0, TriageDesk.getInstance(), Color.BLACK);
    Room MajorsCBay_o = new Room("MajorsCBay", context, space, grid, 264, 27, 23, 14, 1, 0, MajorsCBay.getInstance(), Color.GREEN);
    Room MajorsABBay_p = new Room("MajorsABBay", context, space, grid, 352, 126, 20, 16, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    Room Triage_q = new Room("Triage", context, space, grid, 145, 174, 22, 14, 1, 0, TriageDesk.getInstance(), Color.BLACK);
    Room MajorsABBay_r = new Room("MajorsABBay", context, space, grid, 352, 142, 22, 14, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    Room MajorsABBay_s = new Room("MajorsABBay", context, space, grid, 378, 141, 20, 15, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    Room Triage_t = new Room("Triage", context, space, grid, 143, 189, 21, 12, 1, 0, TriageDesk.getInstance(), Color.BLACK);
    Room MajorsABBay_u = new Room("MajorsABBay", context, space, grid, 380, 121, 20, 12, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    Room MajorsABBay_v = new Room("MajorsABBay", context, space, grid, 322, 103, 24, 12, 1, 0, MajorsABBay.getInstance(), Color.GREEN);
    try {
      AmberBay_a.setSeats(0);
      Lab_b.setSeats(0);
      NonRespiratoryArea_c.setSeats(0);
      RespiratoryArea_d.setSeats(0);
      WaitingRoom_e.setSeats(0);
      WaitingRoom_f.setSeats(0);
      MajorsCBay_g.setSeats(0);
      MajorsABBay_h.setSeats(0);
      MajorsABBay_i.setSeats(0);
      MainEntrance_j.setSeats(0);
      MajorsCBay_k.setSeats(0);
      MajorsCBay_l.setSeats(0);
      MajorsCBay_m.setSeats(0);
      Triage_n.setSeats(0);
      MajorsCBay_o.setSeats(0);
      MajorsABBay_p.setSeats(0);
      Triage_q.setSeats(0);
      MajorsABBay_r.setSeats(0);
      MajorsABBay_s.setSeats(0);
      Triage_t.setSeats(0);
      MajorsABBay_u.setSeats(0);
      MajorsABBay_v.setSeats(0);
      AmberBay_a.setDesks(0);
      Lab_b.setDesks(0);
      NonRespiratoryArea_c.setDesks(0);
      RespiratoryArea_d.setDesks(0);
      WaitingRoom_e.setDesks(0);
      WaitingRoom_f.setDesks(0);
      MajorsCBay_g.setDesks(0);
      MajorsABBay_h.setDesks(0);
      MajorsABBay_i.setDesks(0);
      MainEntrance_j.setDesks(0);
      MajorsCBay_k.setDesks(0);
      MajorsCBay_l.setDesks(0);
      MajorsCBay_m.setDesks(0);
      Triage_n.setDesks(0);
      MajorsCBay_o.setDesks(0);
      MajorsABBay_p.setDesks(0);
      Triage_q.setDesks(0);
      MajorsABBay_r.setDesks(0);
      MajorsABBay_s.setDesks(0);
      Triage_t.setDesks(0);
      MajorsABBay_u.setDesks(0);
      MajorsABBay_v.setDesks(0);
      AmberBay_a.setBeds(0);
      Lab_b.setBeds(0);
      NonRespiratoryArea_c.setBeds(0);
      RespiratoryArea_d.setBeds(0);
      WaitingRoom_e.setBeds(0);
      WaitingRoom_f.setBeds(0);
      MajorsCBay_g.setBeds(0);
      MajorsABBay_h.setBeds(0);
      MajorsABBay_i.setBeds(0);
      MainEntrance_j.setBeds(0);
      MajorsCBay_k.setBeds(0);
      MajorsCBay_l.setBeds(0);
      MajorsCBay_m.setBeds(0);
      Triage_n.setBeds(0);
      MajorsCBay_o.setBeds(0);
      MajorsABBay_p.setBeds(0);
      Triage_q.setBeds(0);
      MajorsABBay_r.setBeds(0);
      MajorsABBay_s.setBeds(0);
      Triage_t.setBeds(0);
      MajorsABBay_u.setBeds(0);
      MajorsABBay_v.setBeds(0);
    } catch (NumberFormatException e) {
    }


    for (Object obj : context) {
      NdPoint pt = space.getLocation(obj);
      grid.moveTo(obj, (int) pt.getX(), (int) pt.getY());
    }

    new NetworkBuilder("CurrentPatientAllocations", context, true).buildNetwork();
    new NetworkBuilder("HistoricalPatientAllocations", context, true).buildNetwork();

    return context;
  }

  public void CreatePatientArrivalMap() {
    HashMap ArrivalPerHour = new HashMap();
    ArrivalPerHour.put(1, 5);
    ArrivalPerHour.put(2, 4);
    ArrivalPerHour.put(3, 5);
    ArrivalPerHour.put(4, 6);
    ArrivalPerHour.put(5, 5);
    ArrivalPerHour.put(6, 4);
    ArrivalPerHour.put(7, 5);
    ArrivalPerHour.put(8, 6);
    ArrivalPerHour.put(9, 7);
    ArrivalPerHour.put(10, 3);
    ArrivalPerHour.put(11, 8);
    ArrivalPerHour.put(12, 4);
    ArrivalPerHour.put(13, 6);
    ArrivalPerHour.put(14, 3);
    ArrivalPerHour.put(15, 3);
    ArrivalPerHour.put(16, 3);
    ArrivalPerHour.put(17, 6);
    ArrivalPerHour.put(18, 3);
    ArrivalPerHour.put(19, 4);
    ArrivalPerHour.put(20, 5);
    ArrivalPerHour.put(21, 6);
    ArrivalPerHour.put(22, 7);
    ArrivalPerHour.put(23, 3);
    ArrivalPerHour.put(24, 4);
    PatientArrivalStore.Initialise((Map<Integer, Integer>) ArrivalPerHour);
  }

  private void createWallBetween(int x1, int y1, int x2, int y2, Context<Object> context, ContinuousSpace<Object> space, Grid<Object> grid) {
    if (x1 == x2) {
      for (int i = y1; i < y2; i++) {
        Wall pWall = new Wall("", context, space, grid, x1, i);
      }
    } else {
      float ratio = (y2 - y1) / (x2 - x1);
      int width = x2 - x1;
      for (int i = 0; i < width; i++) {
        float x = x1 + i;
        float y = y1 + (ratio * i);
        Wall pWall = new Wall("", context, space, grid, ((int) x), ((int) y));
      }

    }
  }
}
